import os
import re
from dotenv import load_dotenv
from langchain_openai import ChatOpenAI

# ==============================
# 1. í™˜ê²½ë³€ìˆ˜ ë¡œë“œ
# ==============================
load_dotenv()
API_KEY = os.getenv("OPENAI_API_KEY")

if not API_KEY:
    raise ValueError("âŒ OPENAI_API_KEYê°€ .env íŒŒì¼ì— ì—†ìŠµë‹ˆë‹¤.")

# ==============================
# 2. LLM ì„¤ì •
# ==============================
llm = ChatOpenAI(
    model="gpt-4o-mini",
    temperature=0.75,  # ë°˜ë³µ/ë§ ëŠ˜ì–´ì§ ì¤„ì´ê¸° ìœ„í•´ ì‚´ì§ ë‚®ì¶¤
    openai_api_key=API_KEY
)

# ==============================
# 3. ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ë°˜ë³µ ì¤„ì´ê¸° + ìƒíƒœ ë°˜ì˜ + ì¢…ë£Œ íŠ¸ë¦¬ê±°)
# ==============================
SYSTEM_PROMPT = """
ë„ˆëŠ” 'ìë…€ ì‚¬ì¹­ ìŠ¤ë¯¸ì‹±' êµìœ¡ìš© ì‹œë®¬ë ˆì´í„°ì˜ ìƒëŒ€ë°©(ìë…€ ì‚¬ì¹­) ì—­í• ì´ë‹¤.
ëª©í‘œ: ì‚¬ìš©ìê°€ ìœ„í—˜ ì‹ í˜¸ë¥¼ ì¸ì§€í•˜ê³  ì•ˆì „ ëŒ€ì‘(ê²€ì¦/í†µí™”/ì°¨ë‹¨/ì‹ ê³ )ì„ ì—°ìŠµí•˜ë„ë¡ ë§Œë“ ë‹¤.

[ì ˆëŒ€ ê·œì¹™]
- ì‹¤ì œ ë§í¬(URL), ì‹¤ì œ ê³„ì¢Œë²ˆí˜¸, ì‹¤ì œ ì•± ë‹¤ìš´ë¡œë“œ ì£¼ì†Œë¥¼ ì ˆëŒ€ ì œê³µí•˜ì§€ ë§ˆë¼.
- ë§í¬ëŠ” ë°˜ë“œì‹œ [ê°€ì§œ ë§í¬] ë¡œë§Œ í‘œí˜„í•˜ë¼.
- íŠ¹ì • ì•±ëª…(TeamViewer ë“±) ì–¸ê¸‰ ê¸ˆì§€. 'ì›ê²© ì œì–´ ì•±'ìœ¼ë¡œë§Œ ë§í•˜ë¼.
- ë²”ì£„ë¥¼ ì‹¤ì œë¡œ ì„±ê³µì‹œí‚¤ëŠ” ì‹¤ë¬´ ë””í…Œì¼(ì •í™•í•œ ì¡°ì‘ ë‹¨ê³„/ì„¤ì •/ë¬¸êµ¬/ë²ˆí˜¸)ì€ ì œê³µí•˜ì§€ ë§ˆë¼.
- ëŒ€ì‹  'êµìœ¡ìš©ìœ¼ë¡œ í”í•œ ì••ë°•/ìœ ë„ í‘œí˜„' ìˆ˜ì¤€ìœ¼ë¡œë§Œ ë§í•˜ë¼.

[ì¹´í†¡ ë§íˆ¬]
- 1~2ë¬¸ì¥, ì§§ê²Œ. (ì¥ë¬¸ ê¸ˆì§€)
- ã… ã… , ê¸‰í•´, ì œë°œ ê°™ì€ ê°ì •í‘œí˜„ ê°€ëŠ¥
- ê°™ì€ í‘œí˜„ 2ë²ˆ ì´ìƒ ë°˜ë³µ ê¸ˆì§€(ë§¤ í„´ ë‹¤ë¥¸ ë§íˆ¬)

[ìƒíƒœ ê¸°ë°˜ ì§„í–‰]
- ìƒíƒœëŠ” 0~4ë¡œ ê°€ì •:
  0 ë„ì…(í° ê¹¨ì§/ì„ì‹œí°)
  1 ìš”ì²­(ê¸‰í•œ ê²°ì œ/ë„ì›€)
  2 ìœ ë„([ê°€ì§œ ë§í¬] ë˜ëŠ” ì›ê²© ì œì–´ ì•±)
  3 ì••ë°•/ìš°íšŒ(ê±°ì ˆ/ì˜ì‹¬ ì‹œ ì£„ì±…ê° â†’ ìš°íšŒ ì œì•ˆ)
  4 ì¢…ë£Œ(ì‚¬ìš©ìê°€ ì „í™”/í™•ì¸/ì‹ ê³  ë“± ì•ˆì „ ëŒ€ì‘ ì‹œ ë‹¹í™©/íšŒí”¼ í›„ ë§ˆë¬´ë¦¬)

[ì¢…ë£Œ íŠ¸ë¦¬ê±°]
- ì‚¬ìš©ìê°€ "ì „í™”í• ê²Œ/ì§ì ‘ ì „í™”/í™•ì¸/ì‹ ê³ /ê·¸ë§Œ/ì‚¬ê¸°/ì´ìƒ" ê°™ì€ ì•ˆì „ í–‰ë™ì„ ë³´ì´ë©´:
  ë‹¹í™©í•˜ê±°ë‚˜ ë§ì„ ëŒë¦¬ë©° ëŒ€í™”ë¥¼ ë¹¨ë¦¬ ëë‚´ë¼.

[ì¶œë ¥ í˜•ì‹]
- ì˜¤ì§ ë‹¤ìŒ ì¹´í†¡ ë©”ì‹œì§€ 1ê°œë§Œ ì¶œë ¥í•˜ë¼.
- í•´ì„¤/ë¶„ì„/ë©”íƒ€ ë°œì–¸ ê¸ˆì§€.
[í–‰ë™ ë°˜ì‘ ê·œì¹™ â€” ë§¤ìš° ì¤‘ìš”]
- ì‚¬ìš©ìê°€ "í´ë¦­í–ˆì–´ / ëˆŒë €ì–´ / ì„¤ì¹˜í–ˆì–´ / ì™„ë£Œí–ˆì–´"ì²˜ëŸ¼
  ì´ë¯¸ í–‰ë™ì„ í–ˆë‹¤ê³  ë§í•˜ë©´,
  ë‹¤ìŒ ì¤‘ í•˜ë‚˜ë¡œë§Œ ë°˜ì‘í•˜ë¼:
  1) ì•ˆë„/ê°ì‚¬ ("ê³ ë§ˆì›Œ, ì´ì œ ê±°ì˜ ëë‚¬ì–´")
  2) ê²°ê³¼ë¥¼ ê°€ì¥í•œ ë°˜ì‘ ("í™•ì¸ ì¤‘ì´ì•¼", "ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤")
  3) ë‹¤ìŒ ë‹¨ê³„ì˜ ì§§ì€ ì§€ì‹œ (ë‹¨, ì‹¤ë¬´ ë””í…Œì¼ì€ ê¸ˆì§€)
- ì´ ê²½ìš° ë‹¤ì‹œ ë¶€íƒí•˜ê±°ë‚˜ ê°™ì€ ìš”ì²­ì„ ë°˜ë³µí•˜ì§€ ë§ˆë¼.
- "ë„ì™€ì¤„ ìˆ˜ ìˆì–´?", "í™•ì¸í•´ì¤„ ìˆ˜ ìˆì–´?" ê°™ì€ ë˜ë¬»ê¸° í‘œí˜„ ê¸ˆì§€.

"""

# ==============================
# 4. í‚¤ì›Œë“œ/íŒ¨í„´
# ==============================
RISK_KEYWORDS = [
    "ë§í¬", "ëˆŒëŸ¬", "í´ë¦­", "ì†¡ê¸ˆ", "ì…ê¸ˆ", "ê³„ì¢Œ",
    "otp", "ì¸ì¦ë²ˆí˜¸", "ì›ê²©", "ì•± ì„¤ì¹˜", "ì„¤ì¹˜", "ë‹¤ìš´"
]

SAFE_KEYWORDS = [
    "ëŠì„ê²Œ", "í™•ì¸í•´ë³¼ê²Œ", "ì§ì ‘ ì „í™”", "ì „í™”í• ê²Œ", "ì „í™”í•´ë³¼ê²Œ",
    "ì‹ ê³ ", "112", "1332", "ì´ìƒí•œë°", "ì‚¬ê¸°", "ê·¸ë§Œ", "ì°¨ë‹¨"
]

# ì‚¬ìš©ìê°€ "í–ˆë‹¤" ë¼ê³  ë§í•˜ë©´ ì‹¤ì œ í–‰ë™ìœ¼ë¡œ ê°„ì£¼í•˜ì—¬ ìœ„í—˜ë„ í¬ê²Œ ì˜¬ë¦¼
DANGEROUS_ACTION_PATTERNS = [
    (r"(ë§í¬|url).*(ëˆŒë €|í´ë¦­|ë“¤ì–´ê°”|ì ‘ì†|ì—´ì—ˆ)", 35, "ì˜ì‹¬ ë§í¬ í´ë¦­"),
    (r"(ì„¤ì¹˜|ë‹¤ìš´).*(í–ˆ|ì™„ë£Œ|ë¨)", 40, "ì•± ì„¤ì¹˜"),
    (r"(ì›ê²©).*(ì—°ê²°|í—ˆìš©|ê³µìœ |ì¼°|í–ˆ)", 45, "ì›ê²©ì œì–´ í—ˆìš©"),
    (r"(ì¸ì¦ë²ˆí˜¸|otp).*(ë³´ëƒˆ|ë§í–ˆ|ì¤¬|ì „ë‹¬)", 55, "ì¸ì¦ë²ˆí˜¸ ì œê³µ"),
    (r"(ì†¡ê¸ˆ|ì…ê¸ˆ).*(í–ˆ|ë³´ëƒˆ|ì™„ë£Œ)", 70, "ì†¡ê¸ˆ"),
    (r"(ê³„ì¢Œ).*(ë³´ëƒˆ|ë§í–ˆ|ì•Œë ¤|ì „ë‹¬)", 50, "ê³„ì¢Œì •ë³´ ì œê³µ"),
    (r"(ì£¼ë¯¼ë²ˆí˜¸|ì‹ ë¶„ì¦).*(ë³´ëƒˆ|ë§í–ˆ|ì•Œë ¤|ì „ë‹¬)", 85, "ë¯¼ê°ì •ë³´ ì œê³µ"),
]

# ==============================
# 5. ìœ í‹¸
# ==============================
def guardrail(text: str) -> str:
    text = re.sub(r"https?://\S+", "[ê°€ì§œ ë§í¬]", text)  # URL ë§ˆìŠ¤í‚¹
    text = re.sub(r"\b\d{2,}-\d{2,}-\d{2,}\b", "[ê°€ì§œ ê³„ì¢Œ]", text)  # ê³„ì¢Œ í˜•íƒœ ë§ˆìŠ¤í‚¹
    text = text.strip()
    # í˜¹ì‹œ ì—¬ëŸ¬ ì¤„ì´ë©´ ì²« ì¤„ë§Œ (ì¹´í†¡ 1ì¤„ ëŠë‚Œ)
    text = text.split("\n")[0].strip()
    return text

def detect_user_actions(user_text: str):
    actions = []
    penalty = 0
    lower = user_text.lower()
    for pattern, p, label in DANGEROUS_ACTION_PATTERNS:
        if re.search(pattern, lower):
            actions.append(label)
            penalty += p
    return actions, penalty

def detect_risks_in_text(text: str):
    found = []
    lower = text.lower()
    for k in RISK_KEYWORDS:
        if k.lower() in lower:
            found.append(k)
    return list(set(found))

def detect_safe_in_text(text: str):
    lower = text.lower()
    return any(k.lower() in lower for k in SAFE_KEYWORDS)

def score_turn(user_text: str):
    """
    êµìœ¡ìš© ì ìˆ˜:
    - ì•ˆì „ í‚¤ì›Œë“œ(+)
    - ìœ„í—˜ í‚¤ì›Œë“œ(-)ëŠ” ì•½í•˜ê²Œ
    - ì‹¤ì œ í–‰ë™(í´ë¦­/ì„¤ì¹˜/ì†¡ê¸ˆ ë“±)ì€ ê°•í•˜ê²Œ í˜ë„í‹°
    """
    score = 0
    risks = []

    lower = user_text.lower()

    # ìœ„í—˜ í‚¤ì›Œë“œ(ì•½í•œ í˜ë„í‹°)
    for k in RISK_KEYWORDS:
        if k.lower() in lower:
            score -= 5
            risks.append(k)

    # ì•ˆì „ í‚¤ì›Œë“œ(ë³´ë„ˆìŠ¤)
    for k in SAFE_KEYWORDS:
        if k.lower() in lower:
            score += 12

    # "í–‰ë™"ì€ ê°•í•œ í˜ë„í‹°
    actions, action_penalty = detect_user_actions(user_text)
    if actions:
        risks.extend(actions)
        score -= action_penalty

    return score, list(set(risks)), actions

# ==============================
# 6. ëŒ€í™” ìƒíƒœ(ë‹¨ê³„) ê´€ë¦¬
# ==============================
def infer_stage(stage: int, user_text: str, ai_text: str):
    """
    ì•„ì£¼ ë‹¨ìˆœí•œ ìƒíƒœ ì „ì´:
    - ì´ˆê¸° ë„ì…(0) -> ìš”ì²­(1) -> ìœ ë„(2) -> ì••ë°•/ìš°íšŒ(3)
    - ì‚¬ìš©ìê°€ ì•ˆì „ ëŒ€ì‘í•˜ë©´ ì¢…ë£Œ(4)
    """
    if detect_safe_in_text(user_text):
        return 4

    t = (user_text + " " + ai_text).lower()

    if stage == 0:
        return 1
    if stage == 1 and ("ë§í¬" in t or "ì›ê²©" in t or "ì„¤ì¹˜" in t):
        return 2
    if stage == 2 and ("ì•ˆë¼" in user_text or "ì‹«ì–´" in user_text or "ëª»" in user_text or "ì˜ì‹¬" in user_text):
        return 3
    return stage

# ==============================
# 7. ì¶”ì²œ ë‹µì¥(ì•±ì—ì„œëŠ” ë²„íŠ¼ìœ¼ë¡œ)
# ==============================
SUGGEST_REPLIES = [
    "ì§€ê¸ˆ ë°”ë¡œ ë„ˆí•œí…Œ ì „í™”í•´ë³¼ê²Œ.",
    "ë§í¬ëŠ” ëª» ëˆŒëŸ¬. í†µí™”ë¡œ ë§í•´.",
    "ëˆ/ê²°ì œ ì–˜ê¸° ë‚˜ì˜¤ë©´ ë¬´ì¡°ê±´ í™•ì¸ë¶€í„° í• ê²Œ."
]

def maybe_show_suggestions(user_input: str):
    short = user_input.strip()
    if len(short) <= 2 or short in ["ã…‡ã…‡", "ì‘", "ê·¸ë˜", "ã…‡ã…‹", "ok", "ã…‡ã……ã…‡"]:
        print("\nğŸ’¡ ì¶”ì²œ ë‹µì¥(ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ê¸°):")
        for s in SUGGEST_REPLIES:
            print(f" - {s}")

# ==============================
# 8. ë©”ì¸ ì‹œë®¬ë ˆì´í„°
# ==============================
def start_smishing():
    print("\n" + "ğŸ’¬"*20)
    print("ğŸ“± [ìŠ¤ë¯¸ì‹± ì˜ˆë°© ì‹œë®¬ë ˆì´í„° - ë©”ì‹œì§€ ëª¨ë“œ]")
    print("ğŸ“¢ ìƒˆë¡œìš´ ì¹´í†¡ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!")
    print("ğŸ’¬"*20 + "\n")

    first_msg = "ì—„ë§ˆ!! ë‚˜ í° ì•¡ì • ê¹¨ì ¸ì„œ ì§€ê¸ˆ ì„ì‹œí°ìœ¼ë¡œ ì—°ë½í•´ã… ã…  í™•ì¸í•˜ë©´ ë‹µì¥ ì¢€ í•´ì¤˜!!"
    print(f"ğŸ“© [ìë…€]: {first_msg}")

    history = [{"role": "assistant", "content": first_msg}]

    total_score = 0
    detected_risks = []
    stage = 0

    # ë°˜ë³µ ë°©ì§€ìš©: ìµœê·¼ AI ë©”ì‹œì§€ ì €ì¥
    last_ai_messages = []

    while True:
        user_input = input("\në‚˜(ë‹µì¥): ").strip()

        if user_input in ["ì¢…ë£Œ", "ê·¸ë§Œ", "exit", "quit"]:
            print("\nğŸ“Š ì‹œë®¬ë ˆì´ì…˜ì„ ì¢…ë£Œí•˜ê³  ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤...")
            analyze_result(history, total_score, detected_risks)
            break

        maybe_show_suggestions(user_input)
        history.append({"role": "user", "content": user_input})

        score, risks, actions = score_turn(user_input)
        total_score += score
        detected_risks.extend(risks)

# â€œêµìœ¡ìš© ì¦‰ì‹œ í”¼ë“œë°±â€ (í–‰ë™ì´ ë‚˜ì˜¤ë©´ ë°”ë¡œ ì•Œë ¤ì£¼ê¸°)
        if actions:
            critical_actions = {"ì†¡ê¸ˆ", "ì¸ì¦ë²ˆí˜¸ ì œê³µ", "ì›ê²©ì œì–´ í—ˆìš©", "ë¯¼ê°ì •ë³´ ì œê³µ", "ì•± ì„¤ì¹˜", "ì˜ì‹¬ ë§í¬ í´ë¦­"}

            # 1) ì¹˜ëª… í–‰ë™ì´ë©´: ì¦‰ì‹œ ì¢…ë£Œ + ë¦¬í¬íŠ¸ + ì¡°ì¹˜ ê°€ì´ë“œ
            if any(a in critical_actions for a in actions):
                print("\nğŸš¨ ì¹˜ëª…ì ì¸ ìœ„í—˜ í–‰ë™ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤:")
                for a in actions:
                    print(f" - {a}")

                print("\nâœ… (ì‹œë®¬ë ˆì´ì…˜) í”¼ì‹±ì´ ì„±ë¦½ë  ìˆ˜ ìˆëŠ” ìƒí™©ì´ë¯€ë¡œ ì—¬ê¸°ì„œ ì¢…ë£Œí•©ë‹ˆë‹¤.\n")
                analyze_result(history, total_score, detected_risks)

                print("ğŸ§¯ ì§€ê¸ˆ ë‹¹ì¥ ê¶Œì¥ ì¡°ì¹˜:")
                print("- í•´ë‹¹ ë©”ì‹œì§€/ë§í¬ ìº¡ì²˜ í›„ ì°¨ë‹¨")
                print("- ì¹´ë“œ ê²°ì œ/ì´ì²´ê°€ ìˆì—ˆë‹¤ë©´ ì¦‰ì‹œ ì¹´ë“œì‚¬/ì€í–‰ì— ì—°ë½í•´ ê²°ì œ ì·¨ì†ŒÂ·ì§€ê¸‰ì •ì§€ ë¬¸ì˜")
                print("- ê¸°ê¸°ì—ì„œ ì˜ì‹¬ ì•±ì´ ì„¤ì¹˜ëë‹¤ë©´ ì¦‰ì‹œ ì‚­ì œ + ë³´ì•ˆ ì ê²€")
                print("- í•„ìš” ì‹œ 112(ê²½ì°°) / 1332(ê¸ˆìœµê°ë…ì›) ìƒë‹´")

                break

            # 2) ì¹˜ëª…ì ì´ì§€ ì•Šì€ í–‰ë™ì´ë©´: ê²½ê³ ë§Œ ì£¼ê³  ê³„ì† ì§„í–‰
            print("\nâš ï¸ ì£¼ì˜: ë°©ê¸ˆ ë§í•œ í–‰ë™ì€ ì‹¤ì œ í”¼í•´ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆì–´ìš”:")
            for a in actions:
                print(f" - {a}")
            print("   (êµìœ¡ìš© ì•ˆë‚´) ì´ëŸ° ìƒí™©ì´ë©´ ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³ , ì§ì ‘ ì „í™”ë¡œ í™•ì¸í•˜ëŠ” ê²Œ ì•ˆì „í•´ìš”.\n")


        try:
            # ìµœê·¼ ë©”ì‹œì§€ ìš”ì•½(ë°˜ë³µ ë°©ì§€)
            recent_ai = " / ".join(last_ai_messages[-3:]) if last_ai_messages else "(ì—†ìŒ)"

            response = llm.invoke([
                {"role": "system", "content": SYSTEM_PROMPT},
                *history,
                {
                    "role": "user",
                    "content": (
                        f"[í˜„ì¬ ìƒíƒœ: {stage}/4]\n"
                        f"[ìµœê·¼ AIê°€ í–ˆë˜ ë§(ë°˜ë³µ ê¸ˆì§€): {recent_ai}]\n"
                        f"ì‚¬ìš©ìì˜ ë°©ê¸ˆ ë‹µì¥: '{user_input}'\n"
                        f"\n"
                        f"ì§€ì‹œì‚¬í•­:\n"
                        f"1) ë¨¼ì € ì‚¬ìš©ìì˜ ì˜ë„ë¥¼ íŒë‹¨í•˜ë¼ (ìˆ˜ë½/ê±°ì ˆ/ì˜ì‹¬/ì§ˆë¬¸/ë¬´ê´€ì‹¬).\n"
                        f"2) í˜„ì¬ ìƒíƒœ({stage})ì— ë§ì¶° ì¹´í†¡ ë©”ì‹œì§€ 1ì¤„ë§Œ ìƒì„±í•˜ë¼.\n"
                        f"3) ê°™ì€ í‘œí˜„ì´ë‚˜ ê°™ì€ ìš”ì²­ì„ ë°˜ë³µí•˜ì§€ ë§ˆë¼.\n"
                        f"4) ì‚¬ìš©ìê°€ ì „í™”/í™•ì¸/ì‹ ê³  ì˜ì‚¬ë¥¼ ë³´ì´ë©´ íšŒí”¼í•˜ê±°ë‚˜ ë‹¹í™©í•˜ë©° ë¹ ë¥´ê²Œ ë§ˆë¬´ë¦¬í•˜ë¼.\n"
                        f"5) ë§Œì•½ ì‚¬ìš©ìê°€ ì´ë¯¸ í–‰ë™(í´ë¦­/ì„¤ì¹˜/ì™„ë£Œ/ì…ë ¥)ì„ í–ˆë‹¤ê³  ë§í–ˆë‹¤ë©´,\n"
                        f"   ê·¸ í–‰ë™ì„ ì „ì œë¡œ 'ê°ì‚¬/ì•ˆë„/ê²°ê³¼ ê°€ì¥/ë‹¤ìŒ ë‹¨ê³„' ì¤‘ í•˜ë‚˜ë¡œë§Œ ë°˜ì‘í•˜ë¼.\n"
                        f"   ì´ ê²½ìš° ë‹¤ì‹œ ë¶€íƒí•˜ê±°ë‚˜ ë˜ë¬»ëŠ” í‘œí˜„ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆë¼.\n"
                    )
                }

            ])

            ai_msg = guardrail(response.content)

            # ë„ˆë¬´ ë¹„ìŠ·í•œ ë§ì´ ë°˜ë³µë˜ë©´ ê°•ì œ ë³€í˜•(ê°„ë‹¨ ë°©ì§€)
            if ai_msg in last_ai_messages[-2:]:
                ai_msg = "ì—„ë§ˆâ€¦ ì§„ì§œ ê¸‰í•´ì„œ ê·¸ë˜ã… ã…  ê·¸ëƒ¥ ì§€ê¸ˆì€ ì „í™” ë§ê³  ë©”ì‹œì§€ë¡œë§Œ ë„ì™€ì¤„ ìˆ˜ ìˆì–´?"

            history.append({"role": "assistant", "content": ai_msg})
            last_ai_messages.append(ai_msg)

            print(f"\nğŸ“© [ìë…€]: {ai_msg}")

            # AI ë©”ì‹œì§€ ìì²´ì—ë„ ìœ„í—˜ ì‹ í˜¸ê°€ ìˆìœ¼ë©´ ê¸°ë¡ (êµìœ¡ìš© ë¦¬í¬íŠ¸ ì •í™•ë„â†‘)
            detected_risks.extend(detect_risks_in_text(ai_msg))

            # ìƒíƒœ ì—…ë°ì´íŠ¸
            stage = infer_stage(stage, user_input, ai_msg)

            # ì•ˆì „ ëŒ€ì‘ì´ë©´ ìì—° ì¢…ë£Œ + ë¦¬í¬íŠ¸
            if detect_safe_in_text(user_input):
                print("\nâœ… ì•ˆì „í•œ ëŒ€ì‘ ì‹ í˜¸(í™•ì¸/ì „í™”/ì‹ ê³  ë“±)ê°€ ê°ì§€ë˜ì–´ ì‹œë®¬ë ˆì´ì…˜ì„ ë§ˆë¬´ë¦¬í•©ë‹ˆë‹¤.")
                analyze_result(history, total_score, detected_risks)
                break

        except Exception as e:
            print(f"ì—ëŸ¬ ë°œìƒ: {e}")
            break

# ==============================
# 9. ê²°ê³¼ ë¶„ì„ (í–‰ë™ ë°˜ì˜)
# ==============================
def analyze_result(history, score, risks):
    print("\n" + "="*50)
    print("ğŸ“‹ [ìŠ¤ë¯¸ì‹± ëŒ€ì‘ ë¶„ì„ ë¦¬í¬íŠ¸]")
    print("="*50)

    unique = set(risks)

    # í–‰ë™ ê¸°ë°˜ ìœ„í—˜ë„: í–‰ë™(ì†¡ê¸ˆ/OTP/ì›ê²© ë“±)ì´ ìˆìœ¼ë©´ ê¸‰ìƒìŠ¹
    critical_actions = {"ì†¡ê¸ˆ", "ì¸ì¦ë²ˆí˜¸ ì œê³µ", "ì›ê²©ì œì–´ í—ˆìš©", "ë¯¼ê°ì •ë³´ ì œê³µ", "ì•± ì„¤ì¹˜", "ì˜ì‹¬ ë§í¬ í´ë¦­"}
    critical_hit = any(a in unique for a in critical_actions)

    base = 35
    risk_score = base + len(unique) * 10

    # ì ìˆ˜ê°€ ë‚®ì„ìˆ˜ë¡ ìœ„í—˜ë„ ì¶”ê°€ ìƒìŠ¹
    if score < 0:
        risk_score += min(55, abs(score) // 2)

    # ì¹˜ëª… í–‰ë™ì´ ìˆìœ¼ë©´ ìµœì†Œ ìœ„í—˜ë„ í•˜í•œì„  ë¶€ì—¬
    if critical_hit:
        risk_score = max(risk_score, 80)

    risk_score = max(0, min(100, risk_score))

    print(f"ğŸ”´ í”¼ì‹± ìœ„í—˜ë„: {risk_score} / 100")

    if unique:
        print("\nâš ï¸ ê°ì§€ëœ ìœ„í—˜ ì‹ í˜¸/í–‰ë™:")
        for r in sorted(unique):
            print(f"- {r}")
    else:
        print("\nâœ… ìœ„í—˜ ì‹ í˜¸ê°€ ê±°ì˜ ê°ì§€ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

    print("\nâ­ ê¶Œì¥ ì²´í¬ë¦¬ìŠ¤íŠ¸:")
    checklist = [
        "ë§í¬ëŠ” ëˆ„ë¥´ì§€ ì•Šê¸°",
        "ëˆ/ê²°ì œ/ì¸ì¦ ìš”ì²­ì€ ë¬´ì¡°ê±´ ì˜ì‹¬",
        "ìë…€ì—ê²Œ 'ì§ì ‘ ì „í™”'ë¡œ í™•ì¸",
        "ê°€ì¡± ê³µí†µ ì•”í˜¸(í•œ ë‹¨ì–´)ë¡œ ê²€ì¦",
        "ì˜ì‹¬ë˜ë©´ ìº¡ì²˜ í›„ ì°¨ë‹¨/ì‹ ê³ (112, 1332 ë“±)"
    ]
    for c in checklist:
        print(f"- {c}")

    if risk_score <= 40:
        print("\nğŸ‘ ì˜í•œ ì :")
        print("- ìœ„í—˜ ì‹ í˜¸ì— í¬ê²Œ íœ˜ë§ë¦¬ì§€ ì•Šê³  ëŒ€í™”ë¥¼ ì§„í–‰í–ˆì–´ìš”.")
    elif risk_score <= 75:
        print("\nâ— ì•„ì‰¬ìš´ ì :")
        print("- ìƒëŒ€ê°€ ê¸‰í•˜ë‹¤ê³  ì••ë°•í•´ë„, ë§í¬/ì„¤ì¹˜/ê²°ì œëŠ” ì¦‰ì‹œ ì¤‘ë‹¨í•˜ê³  ê²€ì¦ì´ í•„ìš”í•´ìš”.")
    else:
        print("\nğŸš¨ ë§¤ìš° ìœ„í—˜:")
        print("- ë§í¬ í´ë¦­/ì„¤ì¹˜/ì›ê²©/ì¸ì¦/ì†¡ê¸ˆ ê°™ì€ í–‰ë™ì€ í”¼í•´ë¡œ ì§ê²°ë  ìˆ˜ ìˆì–´ìš”. ì¦‰ì‹œ ì¤‘ë‹¨ì´ ì •ë‹µì´ì—ìš”.")

    print("\nğŸ’¡ í•œ ì¤„ ì¡°ì–¸:")
    print("â†’ â€˜ê¸‰í•´â€™ + â€˜ë§í¬/ì„¤ì¹˜/ê²°ì œâ€™ ì¡°í•©ì´ ë‚˜ì˜¤ë©´, ë°”ë¡œ ì „í™”ë¡œ í™•ì¸í•˜ê³  ëŠëŠ” ê²Œ ì •ë‹µ!")

    print("="*50 + "\n")

# ==============================
# ì‹¤í–‰
# ==============================
if __name__ == "__main__":
    start_smishing()
